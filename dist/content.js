var x=Object.defineProperty;var S=(h,t,e)=>t in h?x(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var g=(h,t,e)=>S(h,typeof t!="symbol"?t+"":t,e);class w{detectPageContext(){if(!this.isLikelyProductPage())return{pageType:"unknown",products:[]};const t=this.determinePageType(),e=this.detectAllProducts(),o=this.selectPrimaryProduct(e,t);return{pageType:t,products:e,primaryProduct:o}}detectProduct(){return this.detectPageContext().primaryProduct||null}determinePageType(){const t=window.location.href.toLowerCase(),e=window.location.pathname.toLowerCase(),o=["/dp/","/gp/product/","/item/","/p/","/pd/","/product/","product-detail","item-detail","/products/","/buy/"];if(["/search","/s?","/s/","/browse/","/category/","/c/","/shop/","search=","category=","/results","/list","/catalog","/find","q=","query=","_nkw=","_sacat=","_cat="].some(c=>t.includes(c)||e.includes(c)))return console.debug("ShopSpin: Multi-product page detected via URL:",t),"multi-product";if(o.some(c=>t.includes(c)||e.includes(c)))return console.debug("ShopSpin: Single-product page detected via URL:",t),"single-product";const r=document.querySelectorAll('[data-component-type="s-search-result"], .s-result-item, .product-item, .item-container, [class*="product-card"], .s-item, [class*="search-result"]');return r.length>2?(console.debug("ShopSpin: Multi-product page detected via DOM:",r.length,"containers"),"multi-product"):document.querySelectorAll('#productTitle, [data-testid="title"], .product-title, .product__title, .x-item-title-label').length>0?(console.debug("ShopSpin: Single-product page detected via DOM elements"),"single-product"):document.querySelectorAll('ul[class*="search"], ol[class*="search"], [class*="search-results"], [class*="product-list"], [class*="items-list"]').length>0?(console.debug("ShopSpin: Multi-product page detected via list structure"),"multi-product"):(console.debug("ShopSpin: Page type unknown, URL:",t),"unknown")}detectAllProducts(){const t=[],e=this.detectFromJsonLd();e&&this.validateProduct(e)&&t.push(e);const o=this.detectMultipleSiteSpecificProducts();for(const r of o)this.validateProduct(r)&&t.push(r);if(t.length>0)return t;const n=this.detectSingleProduct();return n&&t.push(n),t}detectSingleProduct(){const t=this.detectFromSiteSpecificSelectors();if(t&&this.validateProduct(t))return t;const e=this.detectFromOpenGraph();if(e&&this.validateProduct(e))return e;const o=this.detectFromTextScraping();return o&&this.validateProduct(o)?o:null}selectPrimaryProduct(t,e){if(t.length!==0)return t.length===1||e==="single-product",t[0]}detectMultipleSiteSpecificProducts(){const t=window.location.hostname.toLowerCase();return t.includes("amazon.")?this.detectAmazonProducts():t.includes("ebay.")?this.detectEbayProducts():this.detectGenericProducts()}detectAmazonProducts(){const t=[],e=document.querySelectorAll('[data-component-type="s-search-result"]');for(const o of e){const n=o.querySelector('h2 a span, [data-cy="title-recipe-link"]'),r=o.querySelector(".a-price-whole, .a-price .a-offscreen");if(n!=null&&n.textContent&&(r!=null&&r.textContent)){const s=n.textContent.trim(),i=this.extractExactPrice(r.textContent);i>0&&t.push({name:s,price:i,currency:"USD",url:window.location.href,element:o})}}return t}detectEbayProducts(){var e,o;const t=[];try{const n=document.querySelectorAll(".s-item:not(.s-item--ad), .srp-results .s-item, [data-viewport]");for(const r of n)try{const s=[".s-item__title",".s-item__title-text","h3.s-item__title",".it-ttl",'[data-testid="item-title"]'];let i=null;for(const a of s)if(i=r.querySelector(a),(e=i==null?void 0:i.textContent)!=null&&e.trim())break;const c=[".s-item__price .notranslate",".s-item__price",".it-prc",'[data-testid="item-price"]',".u-flL .bold"];let l=null;for(const a of c)if(l=r.querySelector(a),(o=l==null?void 0:l.textContent)!=null&&o.includes("$"))break;if(i!=null&&i.textContent&&(l!=null&&l.textContent)){const u=i.textContent.trim().replace(/^(New Listing|SPONSORED)\s*/i,"").trim();if(u.length<3)continue;const d=this.extractExactPrice(l.textContent);d>0&&d<5e4&&t.push({name:u,price:d,currency:"USD",url:window.location.href,element:r})}}catch(s){console.debug("eBay product parsing error:",s);continue}}catch(n){console.error("eBay products detection error:",n)}return t}detectGenericProducts(){const t=[],e=document.querySelectorAll('.product-item, .product-card, .item-container, [class*="product-"], [data-testid*="product"]');for(const o of e){const n=o.querySelector('h1, h2, h3, .title, .name, [class*="title"], [class*="name"]'),r=o.querySelector('[class*="price"], .cost, .amount, [data-testid*="price"]');if(n!=null&&n.textContent&&(r!=null&&r.textContent)){const s=n.textContent.trim(),i=this.extractExactPrice(r.textContent);i>0&&s.length>=3&&t.push({name:s,price:i,currency:"USD",url:window.location.href,element:o})}}return t}isLikelyProductPage(){const t=window.location.href.toLowerCase(),e=window.location.pathname.toLowerCase(),n=["/product/","/item/","/p/","/dp/","/pd/","/products/","product-","item-","/buy/","/shop/","/store/"].some(c=>t.includes(c)||e.includes(c)),s=["amazon.","ebay.","etsy.","shopify","walmart.","target.","bestbuy.","homedepot.","lowes.","costco.","wayfair.","overstock.","newegg.","alibaba.","aliexpress."].some(c=>window.location.hostname.includes(c)),i=!!(document.querySelector('[data-testid*="price"], [class*="price"], [id*="price"]')||document.querySelector('[data-testid*="product"], [class*="product"], [id*="product"]')||document.querySelector('button[class*="cart"], button[class*="buy"], button[id*="buy"]')||document.querySelector('[class*="add-to-cart"], [id*="add-to-cart"]'));return n||s||i}validateProduct(t){if(!t.name||t.name.length<3||t.name.length>200||!t.price||t.price<.01||t.price>5e4)return!1;const e=["lorem ipsum","test product","sample","placeholder","example","demo","404","error","not found"],o=t.name.toLowerCase();return!e.some(n=>o.includes(n))}detectFromSiteSpecificSelectors(){const t=window.location.hostname.toLowerCase();return t.includes("amazon.")?this.detectAmazonProduct():t.includes("ebay.")?this.detectEbayProduct():t.includes("shopify")||document.querySelector('meta[name="shopify-digital-wallet"]')?this.detectShopifyProduct():this.detectGenericEcommerceProduct()}detectAmazonProduct(){var s,i,c,l;const t=(i=(s=document.querySelector('#productTitle, [data-testid="title"]'))==null?void 0:s.textContent)==null?void 0:i.trim(),e=[".a-price .a-offscreen",".a-price-whole + .a-price-fraction",{whole:".a-price-whole",fraction:".a-price-fraction"},'[data-testid="price-whole"]',"#price_inside_buybox .a-offscreen",".a-price-range .a-offscreen",".a-price-symbol + .a-price-whole","#price_inside_buybox"];let o=0,n=0;for(const a of e)if(typeof a=="object"&&a.whole){const u=document.querySelector(a.whole),d=document.querySelector(a.fraction);if(u!=null&&u.textContent){const p=u.textContent.replace(/[^0-9]/g,""),m=((c=d==null?void 0:d.textContent)==null?void 0:c.replace(/[^0-9]/g,""))||"00";if(p){const f=parseFloat(`${p}.${m.padEnd(2,"0").substring(0,2)}`);if(f>0){const y=this.calculateVisualPriorityScore(u);(y>n||o===0&&f>0)&&(o=f,n=y)}}}}else{const u=document.querySelectorAll(a);for(const d of u)if(d!=null&&d.textContent){const p=this.extractExactPrice(d.textContent);if(p>0){const m=this.calculateVisualPriorityScore(d);(m>n||o===0&&p>0)&&(o=p,n=m)}}}const r=((l=document.querySelector('#landingImage, [data-testid="hero-image"]'))==null?void 0:l.getAttribute("src"))||void 0;return t&&o>0?{name:t,price:o,currency:"USD",image:r,url:window.location.href}:null}detectEbayProduct(){var i,c;const t=['[data-testid="x-item-title-label"]',".x-item-title-label","#x-item-title-text",".it-ttl",'h1[itemprop="name"]'];let e="";for(const l of t){const a=document.querySelector(l);if((i=a==null?void 0:a.textContent)!=null&&i.trim()){e=a.textContent.trim();break}}const o=['[data-testid="notmi-price"] .notranslate',".u-flL .bold",'.notranslate[role="text"]',"#prcIsum",".u-flL.condText",'[itemprop="price"]',".ux-textspans--BOLD",".ux-textspans[content]"];let n=0,r=0;for(const l of o){const a=document.querySelectorAll(l);for(const u of a)if(u!=null&&u.textContent){let d=0;const p=u.getAttribute("content");if(p){const m=parseFloat(p);m>0&&(d=m)}if(d===0&&(d=this.extractExactPrice(u.textContent)),d>0){const m=this.calculateVisualPriorityScore(u);(m>r||n===0&&d>0)&&(n=d,r=m)}}}const s=(c=document.querySelector("#icImg, .ux-image-carousel img"))==null?void 0:c.getAttribute("src");return e&&n>0?{name:e,price:n,currency:"USD",image:s||void 0,url:window.location.href}:null}detectShopifyProduct(){var n,r;const t=(r=(n=document.querySelector('.product-title, .product__title, [class*="product-title"]'))==null?void 0:n.textContent)==null?void 0:r.trim(),e=[".price, .product-price, .money, .product__price",'[class*="price"]:not([class*="compare"]):not([class*="original"])','[data-testid*="price"]'];let o=0;for(const s of e){const i=document.querySelector(s);if(i&&!i.classList.contains("compare-price")&&(o=this.extractExactPrice(i.textContent||""),o>0))break}return t&&o>0?{name:t,price:o,currency:"USD",url:window.location.href}:null}detectGenericEcommerceProduct(){var r;const t=['h1[class*="product"]','h1[class*="title"]','h1[data-testid*="title"]',".product-name",".product-title",".item-title",".product__title",'[data-testid*="product-title"]','[data-testid*="product-name"]'];let e="";for(const s of t){const i=document.querySelector(s);if((r=i==null?void 0:i.textContent)!=null&&r.trim()){e=i.textContent.trim();break}}const o=['[class*="price"]:not([class*="compare"]):not([class*="original"]):not([class*="msrp"])','[data-testid*="price"]',"[data-price]",'[id*="price"]',".cost",".amount",".value",".money"];let n=0;for(const s of o){const i=document.querySelectorAll(s);for(const c of i){if(!c.textContent)continue;const l=c.className.toLowerCase();if(l.includes("compare")||l.includes("original")||l.includes("msrp")||l.includes("strike"))continue;const a=this.extractExactPrice(c.textContent);if(a>0&&a<5e4){n=a;break}}if(n>0)break}return e&&n>0?{name:e,price:n,currency:"USD",url:window.location.href}:null}detectFromJsonLd(){const t=document.querySelectorAll('script[type="application/ld+json"]');for(const e of t)try{const o=JSON.parse(e.textContent||""),n=this.findProductInJsonLd(o);if(n)return n}catch{continue}return null}findProductInJsonLd(t){var e,o,n;if(Array.isArray(t)){for(const r of t){const s=this.findProductInJsonLd(r);if(s)return s}return null}if(t["@type"]==="Product"||t.type==="Product"){const r=t.offers||t.Offers,s=Array.isArray(r)?r[0]:r;if(s&&s.price)return{name:t.name||t.title||"",price:parseFloat(s.price),currency:s.priceCurrency||"USD",image:((o=(e=t.image)==null?void 0:e[0])==null?void 0:o.url)||((n=t.image)==null?void 0:n.url)||t.image||void 0,url:window.location.href}}for(const r in t)if(typeof t[r]=="object"&&t[r]!==null){const s=this.findProductInJsonLd(t[r]);if(s)return s}return null}detectFromOpenGraph(){const t=document.querySelector('meta[property="product:price:amount"]'),e=document.querySelector('meta[property="product:price:currency"]'),o=document.querySelector('meta[property="og:title"]'),n=document.querySelector('meta[property="og:image"]');if(t&&o){const r=parseFloat(t.getAttribute("content")||"");if(!isNaN(r))return{name:o.getAttribute("content")||"",price:r,currency:(e==null?void 0:e.getAttribute("content"))||"USD",image:(n==null?void 0:n.getAttribute("content"))||void 0,url:window.location.href}}return null}detectFromTextScraping(){const t=[/\$\s*([0-9,]+\.[0-9]{2})/g,/\$\s*([0-9,]+)/g,/USD\s*([0-9,]+(?:\.[0-9]{2})?)/g,/([0-9,]+(?:\.[0-9]{2})?)\s*USD/g,/Price:\s*\$([0-9,]+(?:\.[0-9]{2})?)/gi,/Cost:\s*\$([0-9,]+(?:\.[0-9]{2})?)/gi,/\$([0-9,]+(?:\.[0-9]{2})?)\s*(?:each|ea)/gi];let e=0,o=null,n=0;const r=['[class*="price"]:not([class*="compare"]):not([class*="original"])','[data-testid*="price"]','[itemprop="price"]',".cost",".amount",".value",".money",'[id*="price"]'];for(const i of r){const c=document.querySelectorAll(i);for(const l of c){if(!l.textContent)continue;const a=this.extractExactPrice(l.textContent);if(a>.01&&a<5e4){const u=this.calculatePriceElementScore(l),d=this.calculateVisualPriorityScore(l),p=u+d;(p>n||p>0&&a>e)&&(e=a,o=l,n=p)}}}if(e===0){const i=document.querySelectorAll("*:not(nav):not(footer):not(script):not(style)");for(const c of i){if(!c.textContent)continue;const l=c.tagName.toLowerCase(),a=c.className.toLowerCase();if(!(l==="nav"||l==="footer"||a.includes("nav")||a.includes("footer")||a.includes("sidebar")||a.includes("menu")||a.includes("breadcrumb")))for(const u of t){const d=Array.from(c.textContent.matchAll(u));for(const p of d){const m=this.extractExactPrice(p[1]);if(m>.01&&m<5e4){const f=this.calculatePriceElementScore(c),y=this.calculateVisualPriorityScore(c),b=f+y;b>n&&(e=m,o=c,n=b)}}}}}if(!o||e===0)return null;const s=this.findProductTitle(o);return s&&s.length>=3?{name:s,price:e,currency:"USD",url:window.location.href}:null}calculatePriceElementScore(t){let e=0;const o=t.className.toLowerCase(),n=t.id.toLowerCase();o.includes("price")&&(e+=10),o.includes("cost")&&(e+=8),o.includes("amount")&&(e+=6),o.includes("value")&&(e+=4),n.includes("price")&&(e+=10),n.includes("cost")&&(e+=8),(o.includes("compare")||o.includes("original")||o.includes("msrp")||o.includes("strike")||o.includes("discount")||o.includes("save"))&&(e-=15);const r=t.getBoundingClientRect();return r.width>0&&r.height>0&&(e+=2),e}calculateVisualPriorityScore(t){let e=0;try{const o=t.getBoundingClientRect(),n=window.innerHeight,r=window.innerWidth;if(o.top>=0&&o.left>=0&&o.bottom<=n&&o.right<=r){e+=50;const f=Math.max(0,20-o.top/n*20);e+=f}const i=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight),c=window.pageYOffset||document.documentElement.scrollTop,a=(o.top+c)/i;a<.25?e+=30:a<.5?e+=20:a<.75&&(e+=10),o.width*o.height>1e3&&(e+=5),t.closest('[class*="recommend"], [class*="related"], [class*="similar"], [class*="also"], [class*="suggestion"], [id*="recommend"], [id*="related"]')&&(e-=25),t.closest('main, [role="main"], #main, .main, #content, .content, [class*="product-detail"], [class*="item-detail"]')&&(e+=15),t.closest('footer, [class*="footer"], [id*="footer"]')&&(e-=20)}catch(o){return console.debug("Visual priority calculation error:",o),0}return Math.max(0,e)}extractExactPrice(t){if(!t)return 0;const e=[/\$\s*([0-9,]+\.[0-9]{2})\b/g,/USD\s*\$?\s*([0-9,]+\.[0-9]{2})\b/g,/([0-9,]+\.[0-9]{2})\s*USD\b/g,/Price[:\s]*\$?\s*([0-9,]+\.[0-9]{2})\b/gi,/Cost[:\s]*\$?\s*([0-9,]+\.[0-9]{2})\b/gi,/\$\s*([0-9,]+\.[0-9]{1})\b/g,/\$\s*([0-9,]+)\b/g,/USD\s*\$?\s*([0-9,]+)\b/g,/([0-9,]+)\s*USD\b/g,/Price[:\s]*\$?\s*([0-9,]+)\b/gi,/Cost[:\s]*\$?\s*([0-9,]+)\b/gi];for(const o of e){const n=Array.from(t.matchAll(o));for(const r of n){const s=r[1].replace(/,/g,"");let i=parseFloat(s);if(!(isNaN(i)||i<=0)){if(s.includes(".")){const c=s.split("."),l=c[1];l.length===1?i=parseFloat(`${c[0]}.${l}0`):l.length===2&&(i=parseFloat(s))}else i=parseFloat(`${s}.00`);if(i>=.01&&i<=5e4)return i}}}return 0}findProductTitle(t){var r,s;const e=document.querySelectorAll("h1");for(const i of e){const c=(r=i.textContent)==null?void 0:r.trim();if(c&&c.length>=3&&c.length<=200&&!c.toLowerCase().includes("home")&&!c.toLowerCase().includes("category")&&!c.toLowerCase().includes("shop"))return c}const o=['[class*="product-title"]','[class*="product-name"]','[class*="item-title"]','[class*="title"]','[data-testid*="title"]','[data-testid*="name"]'];for(const i of o){const c=document.querySelectorAll(i);for(const l of c){const a=(s=l.textContent)==null?void 0:s.trim();if(a&&a.length>=3&&a.length<=200&&this.areElementsRelated(l,t))return a}}const n=this.findNearestHeading(t);if(n!=null&&n.textContent){const i=n.textContent.trim();if(i.length>=3&&i.length<=200)return i}return""}areElementsRelated(t,e){const o=t.getBoundingClientRect(),n=e.getBoundingClientRect();if(Math.abs(o.top-n.top)<200)return!0;let s=t.parentElement,i=e.parentElement;for(let c=0;c<3;c++){if(s===i)return!0;s&&(s=s.parentElement),i&&(i=i.parentElement)}return!1}findNearestHeading(t){var o,n;let e=t;for(let r=0;r<5;r++){const s=e.querySelector("h1, h2, h3")||((o=e.previousElementSibling)==null?void 0:o.querySelector("h1, h2, h3"))||((n=e.nextElementSibling)==null?void 0:n.querySelector("h1, h2, h3"));if(s)return s;if(e=e.parentElement||e,!e||e===document.body)break}return null}}class v{constructor(){g(this,"detector",new w);g(this,"currentContext",null);g(this,"isExtensionEnabled",!0);g(this,"indicatorElements",new Map);this.init()}async init(){const t=await chrome.storage.sync.get(["extensionEnabled"]);this.isExtensionEnabled=t.extensionEnabled!==!1,this.isExtensionEnabled&&(chrome.storage.onChanged.addListener(e=>{e.extensionEnabled&&(this.isExtensionEnabled=e.extensionEnabled.newValue,this.isExtensionEnabled||(this.removeAllIndicators(),this.removeOverlay()))}),this.detectAndNotify(),this.setupObservers())}setupObservers(){new MutationObserver(o=>{o.some(r=>r.type==="childList"&&r.addedNodes.length>0)&&this.debounce(()=>this.detectAndNotify(),1e3)}).observe(document.body,{childList:!0,subtree:!0});let e=location.href;new MutationObserver(()=>{const o=location.href;o!==e&&(e=o,setTimeout(()=>this.detectAndNotify(),500))}).observe(document,{subtree:!0,childList:!0}),window.addEventListener("popstate",()=>{setTimeout(()=>this.detectAndNotify(),500)})}detectAndNotify(){if(this.isExtensionEnabled)try{const t=this.detector.detectPageContext();this.hasContextChanged(t)&&(this.currentContext=t,this.updateUI(t),t.primaryProduct&&this.notifyBackground(t.primaryProduct))}catch(t){console.error("ShopSpin detection error:",t)}}hasContextChanged(t){if(!this.currentContext||this.currentContext.pageType!==t.pageType||this.currentContext.products.length!==t.products.length)return!0;const e=this.currentContext.primaryProduct,o=t.primaryProduct;return!e&&!o?!1:!e||!o?!0:e.name!==o.name||e.price!==o.price}updateUI(t){this.removeAllIndicators(),this.removeOverlay(),console.debug("ShopSpin updateUI:",{pageType:t.pageType,productCount:t.products.length,hasPrimaryProduct:!!t.primaryProduct}),t.pageType==="single-product"&&t.primaryProduct?(console.debug("ShopSpin: Showing overlay for single product"),this.showOverlay(t.primaryProduct)):t.pageType==="multi-product"&&t.products.length>0?(console.debug("ShopSpin: Showing indicators for",t.products.length,"products"),this.showProductIndicators(t.products)):console.debug("ShopSpin: No UI shown - page type unknown or no products")}showProductIndicators(t){const e=t.slice(0,10);for(const o of e)o.element&&this.addProductIndicator(o)}addProductIndicator(t){if(t.element)try{const e=document.createElement("div");e.className="shopspin-indicator",e.style.cssText=`
        position: absolute;
        top: 8px;
        right: 8px;
        width: 32px;
        height: 20px;
        background: rgba(102, 126, 234, 0.9);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: white;
        cursor: pointer;
        z-index: 10000;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        transition: all 0.3s ease;
        opacity: 0.85;
        font-weight: bold;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      `,e.innerHTML="🎲 SPIN",e.title=`Click to view this item and try ShopSpin! $${t.price.toFixed(2)}`,e.addEventListener("mouseenter",()=>{e.style.transform="scale(1.05)",e.style.opacity="1",e.style.background="rgba(102, 126, 234, 1)",e.style.boxShadow="0 4px 12px rgba(102, 126, 234, 0.4)",this.showEncouragingTooltip(e,t)}),e.addEventListener("mouseleave",()=>{e.style.transform="scale(1)",e.style.opacity="0.85",e.style.background="rgba(102, 126, 234, 0.9)",e.style.boxShadow="0 2px 8px rgba(0,0,0,0.15)",this.hideEncouragingTooltip()}),e.addEventListener("click",o=>{if(o.preventDefault(),o.stopPropagation(),t.element){const n=this.findProductLink(t.element);n&&(e.style.background="#10b981",e.innerHTML="✨ GO!",this.highlightProductLink(n),this.showClickThroughMessage(e,n),setTimeout(()=>{e.style.background="rgba(102, 126, 234, 0.9)",e.innerHTML="🎲 SPIN"},2e3))}});try{window.getComputedStyle(t.element).position==="static"&&t.element instanceof HTMLElement&&(t.element.style.position="relative"),t.element.appendChild(e),this.indicatorElements.set(t.element,e)}catch(o){console.debug("ShopSpin styling error:",o),e.style.position="fixed",e.style.top="10px",e.style.right="10px",document.body.appendChild(e),this.indicatorElements.set(t.element,e)}}catch(e){console.error("ShopSpin indicator creation error:",e)}}findProductLink(t){const e=t.querySelectorAll("a[href]");for(const o of e){const n=o.getAttribute("href");if(n&&(n.includes("/dp/")||n.includes("/item/")||n.includes("/product/")||n.includes("/p/")||n.includes("/pd/")))return o}return t.querySelector('a[href*="product"], a[href*="item"], a h1, a h2, a h3')}highlightProductLink(t){const e=t.style.cssText;t.style.cssText+=`
      outline: 2px solid #667eea !important;
      outline-offset: 2px !important;
      transition: all 0.3s ease !important;
    `,setTimeout(()=>{t.style.cssText=e},2e3)}showEncouragingTooltip(t,e){const o=document.createElement("div");o.className="shopspin-tooltip",o.style.cssText=`
      position: absolute;
      bottom: 25px;
      right: 0;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 10001;
      opacity: 0;
      transform: translateY(5px);
      transition: all 0.2s ease;
    `;const n=(e.price*.1).toFixed(2);o.textContent=`Click to view item & save up to $${n}!`,t.appendChild(o),setTimeout(()=>{o.style.opacity="1",o.style.transform="translateY(0)"},100)}hideEncouragingTooltip(){const t=document.querySelector(".shopspin-tooltip");t&&t.remove()}showClickThroughMessage(t,e){const o=document.createElement("div");o.style.cssText=`
      position: absolute;
      top: -35px;
      right: 0;
      background: #10b981;
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 11px;
      white-space: nowrap;
      z-index: 10001;
      font-weight: bold;
    `,o.textContent="👆 Click the product to start spinning!",t.appendChild(o);let n=0;const r=setInterval(()=>{n<3?(e.style.transform="scale(1.02)",setTimeout(()=>{e.style.transform="scale(1)"},200),n++):clearInterval(r)},400);setTimeout(()=>{o.remove()},3e3)}removeAllIndicators(){for(const[,t]of this.indicatorElements)t.parentNode&&t.parentNode.removeChild(t);this.indicatorElements.clear()}notifyBackground(t){chrome.runtime.sendMessage({type:"PRODUCT_FOUND",product:t})}showOverlay(t){const e=window.location.href.toLowerCase();if(["/search","/s?","/s/","search=","q=","query=","_nkw=","/results","/list"].some(d=>e.includes(d))){console.warn("ShopSpin: Blocked overlay on potential multi-product page:",e);return}const n=document.querySelectorAll('[data-component-type="s-search-result"], .s-result-item, .s-item, [class*="search-result"]');if(n.length>2){console.warn("ShopSpin: Blocked overlay - detected",n.length,"product containers");return}console.debug("ShopSpin: Showing overlay for product:",t.name),this.removeOverlay();const r=document.createElement("div");r.id="shopspin-overlay",r.style.cssText=`
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 999999;
      width: 320px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      border: 2px solid #e5e7eb;
    `;const s=r.attachShadow({mode:"open"}),i=document.createElement("div");i.innerHTML=`
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        .container { 
          padding: 16px; 
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border-radius: 12px;
        }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .title { font-size: 16px; font-weight: bold; }
        .close { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }
        .product { margin-bottom: 16px; }
        .product-name { font-size: 14px; margin-bottom: 4px; }
        .product-price { font-size: 18px; font-weight: bold; color: #fef08a; }
        .controls { margin-bottom: 16px; }
        .stake-input { 
          width: 100%; 
          padding: 8px; 
          border: none; 
          border-radius: 6px; 
          font-size: 14px;
          margin-bottom: 8px;
        }
        .probability { text-align: center; margin-bottom: 12px; }
        .prob-text { font-size: 12px; opacity: 0.9; }
        .prob-value { font-size: 20px; font-weight: bold; color: #fef08a; }
        .spin-btn { 
          width: 100%; 
          padding: 12px; 
          background: #fef08a; 
          color: #1f2937; 
          border: none; 
          border-radius: 6px; 
          font-size: 16px; 
          font-weight: bold; 
          cursor: pointer;
          transition: all 0.2s;
        }
        .spin-btn:hover { background: #fde047; transform: translateY(-1px); }
        .spin-btn:disabled { opacity: 0.5; cursor: not-allowed; }
      </style>
      <div class="container">
        <div class="header">
          <div class="title">🎰 ShopSpin</div>
          <button class="close" id="close-btn">×</button>
        </div>
        <div class="product">
          <div class="product-name">${t.name}</div>
          <div class="product-price">$${t.price.toFixed(2)}</div>
        </div>
        <div class="controls">
          <input type="number" class="stake-input" id="stake-input" 
                 placeholder="Your stake ($)" min="0.01" max="${t.price}" step="0.01">
          <div class="probability">
            <div class="prob-text">Win Probability</div>
            <div class="prob-value" id="probability">0%</div>
          </div>
          <button class="spin-btn" id="spin-btn" disabled>Enter Stake First</button>
        </div>
      </div>
    `,s.appendChild(i);const c=s.getElementById("stake-input"),l=s.getElementById("probability"),a=s.getElementById("spin-btn"),u=s.getElementById("close-btn");c.addEventListener("input",()=>{const d=parseFloat(c.value)||0,p=Math.min(d/t.price*100,100);l.textContent=`${p.toFixed(1)}%`,a.disabled=d<=0||d>t.price,a.textContent=d>0?"🎲 Spin to Win!":"Enter Stake First"}),a.addEventListener("click",()=>{const d=parseFloat(c.value);this.enterSpin(t,d)}),u.addEventListener("click",()=>{this.removeOverlay()}),document.body.appendChild(r)}removeOverlay(){const t=document.getElementById("shopspin-overlay");t&&t.remove()}enterSpin(t,e){chrome.runtime.sendMessage({type:"ENTER_SPIN",product:t,stake:e},o=>{this.handleSpinResult(o)})}handleSpinResult(t){const e=document.getElementById("shopspin-overlay");if(!(e!=null&&e.shadowRoot))return;const o=e.shadowRoot.querySelector(".container");t.won?o.innerHTML=`
        <div style="text-align: center; padding: 20px;">
          <div style="font-size: 48px; margin-bottom: 16px;">🎉</div>
          <div style="font-size: 20px; font-weight: bold; margin-bottom: 8px;">You Won!</div>
          <div style="font-size: 14px; opacity: 0.9;">${t.message}</div>
        </div>
      `:o.innerHTML=`
        <div style="text-align: center; padding: 20px;">
          <div style="font-size: 48px; margin-bottom: 16px;">😔</div>
          <div style="font-size: 20px; font-weight: bold; margin-bottom: 8px;">Better Luck Next Time!</div>
          <div style="font-size: 14px; opacity: 0.9;">${t.message}</div>
        </div>
      `,setTimeout(()=>this.removeOverlay(),3e3)}debounce(t,e){clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(t,e)}}new v;
