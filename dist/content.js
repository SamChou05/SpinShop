var b=Object.defineProperty;var x=(g,t,e)=>t in g?b(g,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):g[t]=e;var y=(g,t,e)=>x(g,typeof t!="symbol"?t+"":t,e);class P{detectPageContext(){if(console.log("ðŸŽ° ShopSpin: detectPageContext starting..."),!this.isLikelyProductPage())return console.log("ðŸŽ° ShopSpin: Not a likely product page"),{pageType:"unknown",products:[]};console.log("ðŸŽ° ShopSpin: Likely product page detected");const t=this.determinePageType();console.log("ðŸŽ° ShopSpin: Page type determined:",t);const e=this.detectAllProducts();console.log("ðŸŽ° ShopSpin: Products detected:",e.length);const o=this.selectPrimaryProduct(e,t);return console.log("ðŸŽ° ShopSpin: Primary product:",(o==null?void 0:o.name)||"none"),{pageType:t,products:e,primaryProduct:o}}detectProduct(){return this.detectPageContext().primaryProduct||null}determinePageType(){const t=window.location.href.toLowerCase(),e=window.location.pathname.toLowerCase(),o=["/dp/","/gp/product/","/item/","/p/","/pd/","/product/","product-detail","item-detail","/products/","/buy/"];if(["/search","/s?","/s/","/browse/","/category/","/c/","/shop/","search=","category=","/results","/list","/catalog","/find","q=","query=","_nkw=","_sacat=","_cat=","/bestsellers","/gp/bestsellers","/best-sellers","/top-rated","/most-popular","/trending"].some(c=>t.includes(c)||e.includes(c)))return console.debug("ShopSpin: Multi-product page detected via URL:",t),"multi-product";if(o.some(c=>t.includes(c)||e.includes(c)))return console.debug("ShopSpin: Single-product page detected via URL:",t),"single-product";const r=document.querySelectorAll('[data-component-type="s-search-result"], .s-result-item, .product-item, .item-container, [class*="product-card"], .s-item, [class*="search-result"]');return r.length>2?(console.debug("ShopSpin: Multi-product page detected via DOM:",r.length,"containers"),"multi-product"):document.querySelectorAll('#productTitle, [data-testid="title"], .product-title, .product__title, .x-item-title-label').length>0?(console.debug("ShopSpin: Single-product page detected via DOM elements"),"single-product"):document.querySelectorAll('ul[class*="search"], ol[class*="search"], [class*="search-results"], [class*="product-list"], [class*="items-list"]').length>0?(console.debug("ShopSpin: Multi-product page detected via list structure"),"multi-product"):(console.debug("ShopSpin: Page type unknown, URL:",t),"unknown")}detectAllProducts(){const t=[];console.debug("ShopSpin: Starting detectAllProducts...");const e=this.determinePageType();if(e==="single-product"){console.debug("ShopSpin: Using single-product detection strategy...");const o=this.detectFromJsonLd();if(o&&this.validateProduct(o))return console.debug("ShopSpin: Found JSON-LD product:",o.name),t.push(o),t;const n=this.detectSingleProduct();if(n)return console.debug("ShopSpin: Single product found:",n.name),t.push(n),t}else if(e==="multi-product"){console.debug("ShopSpin: Using multi-product detection strategy...");const o=this.detectFromJsonLd();o&&this.validateProduct(o)&&(console.debug("ShopSpin: Found JSON-LD product:",o.name),t.push(o));const n=this.detectMultipleSiteSpecificProducts();console.debug("ShopSpin: Site-specific products found:",n.length);for(const r of n)this.validateProduct(r)?(t.push(r),console.debug("ShopSpin: Valid site product added:",r.name)):console.debug("ShopSpin: Invalid site product skipped:",r.name)}else{console.debug("ShopSpin: Using fallback detection strategy...");const o=this.detectFromJsonLd();o&&this.validateProduct(o)&&(console.debug("ShopSpin: Found JSON-LD product:",o.name),t.push(o));const n=this.detectSingleProduct();if(n&&this.validateProduct(n)&&(console.debug("ShopSpin: Single product found:",n.name),t.push(n)),t.length===0){const r=this.detectMultipleSiteSpecificProducts();for(const s of r)this.validateProduct(s)&&t.push(s)}}return console.debug("ShopSpin: Final product count:",t.length),t}detectSingleProduct(){const t=this.detectFromSiteSpecificSelectors();if(t&&this.validateProduct(t))return t;const e=this.detectFromOpenGraph();if(e&&this.validateProduct(e))return e;const o=this.detectFromTextScraping();return o&&this.validateProduct(o)?o:null}selectPrimaryProduct(t,e){if(t.length!==0)return t.length===1||e==="single-product",t[0]}detectMultipleSiteSpecificProducts(){const t=window.location.hostname.toLowerCase();return t.includes("amazon.")?this.detectAmazonProducts():t.includes("ebay.")?this.detectEbayProducts():this.detectGenericProducts()}detectAmazonProducts(){var o,n,r,s;const t=[];console.log("ðŸŽ° ShopSpin: Detecting Amazon products...");const e=document.querySelectorAll('[data-component-type="s-search-result"]');console.log("ðŸŽ° ShopSpin: Found search result containers:",e.length);for(const i of e){const c=i.querySelector('h2 a span, [data-cy="title-recipe-link"]'),l=i.querySelector(".a-price-whole, .a-price .a-offscreen");if(c!=null&&c.textContent&&(l!=null&&l.textContent)){const a=c.textContent.trim(),d=this.extractExactPrice(l.textContent);d>0&&t.push({name:a,price:d,currency:"USD",url:window.location.href,element:i})}}if(t.length===0){console.log("ðŸŽ° ShopSpin: No search results, trying best sellers/listing selectors...");const i=document.querySelectorAll([".p13n-sc-uncoverable-faceout",".a-carousel-card",'[data-testid="product-card"]',".s-result-item",".p13n-asin","[data-asin]"].join(", "));console.log("ðŸŽ° ShopSpin: Found listing items:",i.length),i.length>0&&console.log("ðŸŽ° ShopSpin: First item sample:",{tagName:i[0].tagName,className:i[0].className,innerHTML:i[0].innerHTML.slice(0,200)});for(const[c,l]of i.entries()){c<5&&console.log("ðŸŽ° ShopSpin: Processing item",c,"classes:",l.className);const a=["h3 a span","h2 a span","h4 a span",".p13n-sc-truncate",'[data-testid="title"]',".a-link-normal span",'a[href*="/dp/"]',".s-link-style span","h3","h2","h4",".a-link-normal","a"];let d=null,u="";for(const h of a)if(d=l.querySelector(h),(o=d==null?void 0:d.textContent)!=null&&o.trim()){u=h;break}const m=[".a-price .a-offscreen",".a-price-whole",".p13n-sc-price",'[data-testid="price"]',".a-link-normal .a-price",".s-price",".a-price",'[class*="price"]'];let p=null,f="";for(const h of m)if(p=l.querySelector(h),(n=p==null?void 0:p.textContent)!=null&&n.includes("$")){f=h;break}if(c<5&&(console.log("ðŸŽ° ShopSpin: Item",c,"title found?",!!d,"selector:",u),console.log("ðŸŽ° ShopSpin: Item",c,"price found?",!!p,"selector:",f),d&&console.log("ðŸŽ° ShopSpin: Item",c,"title text:",(r=d.textContent)==null?void 0:r.slice(0,50)),p&&console.log("ðŸŽ° ShopSpin: Item",c,"price text:",(s=p.textContent)==null?void 0:s.slice(0,20))),d!=null&&d.textContent&&(p!=null&&p.textContent)){const h=d.textContent.trim(),S=this.extractExactPrice(p.textContent);S>0&&h.length>3&&(console.log("ðŸŽ° ShopSpin: Found listing product:",h,"$"+S),t.push({name:h,price:S,currency:"USD",url:window.location.href,element:l}))}}}return console.log("ðŸŽ° ShopSpin: Amazon products found:",t.length),t}detectEbayProducts(){var e,o;const t=[];try{const n=document.querySelectorAll(".s-item:not(.s-item--ad), .srp-results .s-item, [data-viewport]");for(const r of n)try{const s=[".s-item__title",".s-item__title-text","h3.s-item__title",".it-ttl",'[data-testid="item-title"]'];let i=null;for(const a of s)if(i=r.querySelector(a),(e=i==null?void 0:i.textContent)!=null&&e.trim())break;const c=[".s-item__price .notranslate",".s-item__price",".it-prc",'[data-testid="item-price"]',".u-flL .bold"];let l=null;for(const a of c)if(l=r.querySelector(a),(o=l==null?void 0:l.textContent)!=null&&o.includes("$"))break;if(i!=null&&i.textContent&&(l!=null&&l.textContent)){const d=i.textContent.trim().replace(/^(New Listing|SPONSORED)\s*/i,"").trim();if(d.length<3)continue;const u=this.extractExactPrice(l.textContent);u>0&&u<5e4&&t.push({name:d,price:u,currency:"USD",url:window.location.href,element:r})}}catch(s){console.debug("eBay product parsing error:",s);continue}}catch(n){console.error("eBay products detection error:",n)}return t}detectGenericProducts(){const t=[],e=document.querySelectorAll('.product-item, .product-card, .item-container, [class*="product-"], [data-testid*="product"]');for(const o of e){const n=o.querySelector('h1, h2, h3, .title, .name, [class*="title"], [class*="name"]'),r=o.querySelector('[class*="price"], .cost, .amount, [data-testid*="price"]');if(n!=null&&n.textContent&&(r!=null&&r.textContent)){const s=n.textContent.trim(),i=this.extractExactPrice(r.textContent);i>0&&s.length>=3&&t.push({name:s,price:i,currency:"USD",url:window.location.href,element:o})}}return t}isLikelyProductPage(){const t=window.location.href.toLowerCase(),e=window.location.pathname.toLowerCase(),n=["/product/","/item/","/p/","/dp/","/pd/","/products/","product-","item-","/buy/","/shop/","/store/"].some(c=>t.includes(c)||e.includes(c)),s=["amazon.","ebay.","etsy.","shopify","walmart.","target.","bestbuy.","homedepot.","lowes.","costco.","wayfair.","overstock.","newegg.","alibaba.","aliexpress."].some(c=>window.location.hostname.includes(c)),i=!!(document.querySelector('[data-testid*="price"], [class*="price"], [id*="price"]')||document.querySelector('[data-testid*="product"], [class*="product"], [id*="product"]')||document.querySelector('button[class*="cart"], button[class*="buy"], button[id*="buy"]')||document.querySelector('[class*="add-to-cart"], [id*="add-to-cart"]'));return n||s||i}validateProduct(t){if(!t.name||t.name.length<3||t.name.length>200||!t.price||t.price<.01||t.price>5e4)return!1;const e=["lorem ipsum","test product","sample","placeholder","example","demo","404","error","not found"],o=t.name.toLowerCase();return!e.some(n=>o.includes(n))}detectFromSiteSpecificSelectors(){const t=window.location.hostname.toLowerCase();return t.includes("amazon.")?this.detectAmazonProduct():t.includes("ebay.")?this.detectEbayProduct():t.includes("shopify")||document.querySelector('meta[name="shopify-digital-wallet"]')?this.detectShopifyProduct():this.detectGenericEcommerceProduct()}detectAmazonProduct(){var s,i,c,l;const t=(i=(s=document.querySelector('#productTitle, [data-testid="title"]'))==null?void 0:s.textContent)==null?void 0:i.trim(),e=[".a-price .a-offscreen",".a-price-whole + .a-price-fraction",{whole:".a-price-whole",fraction:".a-price-fraction"},'[data-testid="price-whole"]',"#price_inside_buybox .a-offscreen",".a-price-range .a-offscreen",".a-price-symbol + .a-price-whole","#price_inside_buybox"];let o=0,n=0;for(const a of e)if(typeof a=="object"&&a.whole){const d=document.querySelector(a.whole),u=document.querySelector(a.fraction);if(d!=null&&d.textContent){const m=d.textContent.replace(/[^0-9]/g,""),p=((c=u==null?void 0:u.textContent)==null?void 0:c.replace(/[^0-9]/g,""))||"00";if(m){const f=parseFloat(`${m}.${p.padEnd(2,"0").substring(0,2)}`);if(f>0){const h=this.calculateVisualPriorityScore(d);(h>n||o===0&&f>0)&&(o=f,n=h)}}}}else{const d=document.querySelectorAll(a);for(const u of d)if(u!=null&&u.textContent){const m=this.extractExactPrice(u.textContent);if(m>0){const p=this.calculateVisualPriorityScore(u);(p>n||o===0&&m>0)&&(o=m,n=p)}}}const r=((l=document.querySelector('#landingImage, [data-testid="hero-image"]'))==null?void 0:l.getAttribute("src"))||void 0;return t&&o>0?{name:t,price:o,currency:"USD",image:r,url:window.location.href}:null}detectEbayProduct(){var i,c;const t=['[data-testid="x-item-title-label"]',".x-item-title-label","#x-item-title-text",".it-ttl",'h1[itemprop="name"]'];let e="";for(const l of t){const a=document.querySelector(l);if((i=a==null?void 0:a.textContent)!=null&&i.trim()){e=a.textContent.trim();break}}const o=['[data-testid="notmi-price"] .notranslate',".u-flL .bold",'.notranslate[role="text"]',"#prcIsum",".u-flL.condText",'[itemprop="price"]',".ux-textspans--BOLD",".ux-textspans[content]"];let n=0,r=0;for(const l of o){const a=document.querySelectorAll(l);for(const d of a)if(d!=null&&d.textContent){let u=0;const m=d.getAttribute("content");if(m){const p=parseFloat(m);p>0&&(u=p)}if(u===0&&(u=this.extractExactPrice(d.textContent)),u>0){const p=this.calculateVisualPriorityScore(d);(p>r||n===0&&u>0)&&(n=u,r=p)}}}const s=(c=document.querySelector("#icImg, .ux-image-carousel img"))==null?void 0:c.getAttribute("src");return e&&n>0?{name:e,price:n,currency:"USD",image:s||void 0,url:window.location.href}:null}detectShopifyProduct(){var n,r;const t=(r=(n=document.querySelector('.product-title, .product__title, [class*="product-title"]'))==null?void 0:n.textContent)==null?void 0:r.trim(),e=[".price, .product-price, .money, .product__price",'[class*="price"]:not([class*="compare"]):not([class*="original"])','[data-testid*="price"]'];let o=0;for(const s of e){const i=document.querySelector(s);if(i&&!i.classList.contains("compare-price")&&(o=this.extractExactPrice(i.textContent||""),o>0))break}return t&&o>0?{name:t,price:o,currency:"USD",url:window.location.href}:null}detectGenericEcommerceProduct(){var r;const t=['h1[class*="product"]','h1[class*="title"]','h1[data-testid*="title"]',".product-name",".product-title",".item-title",".product__title",'[data-testid*="product-title"]','[data-testid*="product-name"]'];let e="";for(const s of t){const i=document.querySelector(s);if((r=i==null?void 0:i.textContent)!=null&&r.trim()){e=i.textContent.trim();break}}const o=['[class*="price"]:not([class*="compare"]):not([class*="original"]):not([class*="msrp"])','[data-testid*="price"]',"[data-price]",'[id*="price"]',".cost",".amount",".value",".money"];let n=0;for(const s of o){const i=document.querySelectorAll(s);for(const c of i){if(!c.textContent)continue;const l=c.className.toLowerCase();if(l.includes("compare")||l.includes("original")||l.includes("msrp")||l.includes("strike"))continue;const a=this.extractExactPrice(c.textContent);if(a>0&&a<5e4){n=a;break}}if(n>0)break}return e&&n>0?{name:e,price:n,currency:"USD",url:window.location.href}:null}detectFromJsonLd(){const t=document.querySelectorAll('script[type="application/ld+json"]');for(const e of t)try{const o=JSON.parse(e.textContent||""),n=this.findProductInJsonLd(o);if(n)return n}catch{continue}return null}findProductInJsonLd(t){var e,o,n;if(Array.isArray(t)){for(const r of t){const s=this.findProductInJsonLd(r);if(s)return s}return null}if(t["@type"]==="Product"||t.type==="Product"){const r=t.offers||t.Offers,s=Array.isArray(r)?r[0]:r;if(s&&s.price)return{name:t.name||t.title||"",price:parseFloat(s.price),currency:s.priceCurrency||"USD",image:((o=(e=t.image)==null?void 0:e[0])==null?void 0:o.url)||((n=t.image)==null?void 0:n.url)||t.image||void 0,url:window.location.href}}for(const r in t)if(typeof t[r]=="object"&&t[r]!==null){const s=this.findProductInJsonLd(t[r]);if(s)return s}return null}detectFromOpenGraph(){const t=document.querySelector('meta[property="product:price:amount"]'),e=document.querySelector('meta[property="product:price:currency"]'),o=document.querySelector('meta[property="og:title"]'),n=document.querySelector('meta[property="og:image"]');if(t&&o){const r=parseFloat(t.getAttribute("content")||"");if(!isNaN(r))return{name:o.getAttribute("content")||"",price:r,currency:(e==null?void 0:e.getAttribute("content"))||"USD",image:(n==null?void 0:n.getAttribute("content"))||void 0,url:window.location.href}}return null}detectFromTextScraping(){const t=[/\$\s*([0-9,]+\.[0-9]{2})/g,/\$\s*([0-9,]+)/g,/USD\s*([0-9,]+(?:\.[0-9]{2})?)/g,/([0-9,]+(?:\.[0-9]{2})?)\s*USD/g,/Price:\s*\$([0-9,]+(?:\.[0-9]{2})?)/gi,/Cost:\s*\$([0-9,]+(?:\.[0-9]{2})?)/gi,/\$([0-9,]+(?:\.[0-9]{2})?)\s*(?:each|ea)/gi];let e=0,o=null,n=0;const r=['[class*="price"]:not([class*="compare"]):not([class*="original"])','[data-testid*="price"]','[itemprop="price"]',".cost",".amount",".value",".money",'[id*="price"]'];for(const i of r){const c=document.querySelectorAll(i);for(const l of c){if(!l.textContent)continue;const a=this.extractExactPrice(l.textContent);if(a>.01&&a<5e4){const d=this.calculatePriceElementScore(l),u=this.calculateVisualPriorityScore(l),m=d+u;(m>n||m>0&&a>e)&&(e=a,o=l,n=m)}}}if(e===0){const i=document.querySelectorAll("*:not(nav):not(footer):not(script):not(style)");for(const c of i){if(!c.textContent)continue;const l=c.tagName.toLowerCase(),a=c.className.toLowerCase();if(!(l==="nav"||l==="footer"||a.includes("nav")||a.includes("footer")||a.includes("sidebar")||a.includes("menu")||a.includes("breadcrumb")))for(const d of t){const u=Array.from(c.textContent.matchAll(d));for(const m of u){const p=this.extractExactPrice(m[1]);if(p>.01&&p<5e4){const f=this.calculatePriceElementScore(c),h=this.calculateVisualPriorityScore(c),S=f+h;S>n&&(e=p,o=c,n=S)}}}}}if(!o||e===0)return null;const s=this.findProductTitle(o);return s&&s.length>=3?{name:s,price:e,currency:"USD",url:window.location.href}:null}calculatePriceElementScore(t){let e=0;const o=t.className.toLowerCase(),n=t.id.toLowerCase();o.includes("price")&&(e+=10),o.includes("cost")&&(e+=8),o.includes("amount")&&(e+=6),o.includes("value")&&(e+=4),n.includes("price")&&(e+=10),n.includes("cost")&&(e+=8),(o.includes("compare")||o.includes("original")||o.includes("msrp")||o.includes("strike")||o.includes("discount")||o.includes("save"))&&(e-=15);const r=t.getBoundingClientRect();return r.width>0&&r.height>0&&(e+=2),e}calculateVisualPriorityScore(t){let e=0;try{const o=t.getBoundingClientRect(),n=window.innerHeight,r=window.innerWidth;if(o.top>=0&&o.left>=0&&o.bottom<=n&&o.right<=r){e+=50;const f=Math.max(0,20-o.top/n*20);e+=f}const i=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight),c=window.pageYOffset||document.documentElement.scrollTop,a=(o.top+c)/i;a<.25?e+=30:a<.5?e+=20:a<.75&&(e+=10),o.width*o.height>1e3&&(e+=5),t.closest('[class*="recommend"], [class*="related"], [class*="similar"], [class*="also"], [class*="suggestion"], [id*="recommend"], [id*="related"]')&&(e-=25),t.closest('main, [role="main"], #main, .main, #content, .content, [class*="product-detail"], [class*="item-detail"]')&&(e+=15),t.closest('footer, [class*="footer"], [id*="footer"]')&&(e-=20)}catch(o){return console.debug("Visual priority calculation error:",o),0}return Math.max(0,e)}extractExactPrice(t){if(!t)return 0;const e=[/\$\s*([0-9,]+\.[0-9]{2})\b/g,/USD\s*\$?\s*([0-9,]+\.[0-9]{2})\b/g,/([0-9,]+\.[0-9]{2})\s*USD\b/g,/Price[:\s]*\$?\s*([0-9,]+\.[0-9]{2})\b/gi,/Cost[:\s]*\$?\s*([0-9,]+\.[0-9]{2})\b/gi,/\$\s*([0-9,]+\.[0-9]{1})\b/g,/\$\s*([0-9,]+)\b/g,/USD\s*\$?\s*([0-9,]+)\b/g,/([0-9,]+)\s*USD\b/g,/Price[:\s]*\$?\s*([0-9,]+)\b/gi,/Cost[:\s]*\$?\s*([0-9,]+)\b/gi];for(const o of e){const n=Array.from(t.matchAll(o));for(const r of n){const s=r[1].replace(/,/g,"");let i=parseFloat(s);if(!(isNaN(i)||i<=0)){if(s.includes(".")){const c=s.split("."),l=c[1];l.length===1?i=parseFloat(`${c[0]}.${l}0`):l.length===2&&(i=parseFloat(s))}else i=parseFloat(`${s}.00`);if(i>=.01&&i<=5e4)return i}}}return 0}findProductTitle(t){var r,s;const e=document.querySelectorAll("h1");for(const i of e){const c=(r=i.textContent)==null?void 0:r.trim();if(c&&c.length>=3&&c.length<=200&&!c.toLowerCase().includes("home")&&!c.toLowerCase().includes("category")&&!c.toLowerCase().includes("shop"))return c}const o=['[class*="product-title"]','[class*="product-name"]','[class*="item-title"]','[class*="title"]','[data-testid*="title"]','[data-testid*="name"]'];for(const i of o){const c=document.querySelectorAll(i);for(const l of c){const a=(s=l.textContent)==null?void 0:s.trim();if(a&&a.length>=3&&a.length<=200&&this.areElementsRelated(l,t))return a}}const n=this.findNearestHeading(t);if(n!=null&&n.textContent){const i=n.textContent.trim();if(i.length>=3&&i.length<=200)return i}return""}areElementsRelated(t,e){const o=t.getBoundingClientRect(),n=e.getBoundingClientRect();if(Math.abs(o.top-n.top)<200)return!0;let s=t.parentElement,i=e.parentElement;for(let c=0;c<3;c++){if(s===i)return!0;s&&(s=s.parentElement),i&&(i=i.parentElement)}return!1}findNearestHeading(t){var o,n;let e=t;for(let r=0;r<5;r++){const s=e.querySelector("h1, h2, h3")||((o=e.previousElementSibling)==null?void 0:o.querySelector("h1, h2, h3"))||((n=e.nextElementSibling)==null?void 0:n.querySelector("h1, h2, h3"));if(s)return s;if(e=e.parentElement||e,!e||e===document.body)break}return null}}class v{constructor(){y(this,"detector",new P);y(this,"currentContext",null);y(this,"isExtensionEnabled",!0);y(this,"indicatorElements",new Map);this.init()}async init(){console.log("ðŸŽ° ShopSpin: ContentScript initializing...");const t=await chrome.storage.sync.get(["extensionEnabled"]);if(this.isExtensionEnabled=t.extensionEnabled!==!1,console.log("ðŸŽ° ShopSpin: Extension enabled?",this.isExtensionEnabled),!this.isExtensionEnabled){console.log("ðŸŽ° ShopSpin: Extension disabled, exiting init");return}chrome.storage.onChanged.addListener(e=>{e.extensionEnabled&&(this.isExtensionEnabled=e.extensionEnabled.newValue,console.log("ðŸŽ° ShopSpin: Extension enabled changed to:",this.isExtensionEnabled),this.isExtensionEnabled||(this.removeAllIndicators(),this.removeOverlay()))}),console.log("ðŸŽ° ShopSpin: Starting initial detection..."),setTimeout(()=>this.detectAndNotify(),1e3),this.setupObservers()}setupObservers(){new MutationObserver(o=>{o.some(r=>r.type==="childList"&&r.addedNodes.length>0)&&this.debounce(()=>this.detectAndNotify(),1e3)}).observe(document.body,{childList:!0,subtree:!0});let e=location.href;new MutationObserver(()=>{const o=location.href;o!==e&&(e=o,setTimeout(()=>this.detectAndNotify(),500))}).observe(document,{subtree:!0,childList:!0}),window.addEventListener("popstate",()=>{setTimeout(()=>this.detectAndNotify(),500)})}detectAndNotify(){var t;if(console.log("ðŸŽ° ShopSpin: detectAndNotify called, extensionEnabled:",this.isExtensionEnabled),!this.isExtensionEnabled){console.log("ðŸŽ° ShopSpin: Extension disabled, returning");return}try{console.log("ðŸŽ° ShopSpin: Starting page context detection...");const e=this.detector.detectPageContext();console.log("ðŸŽ° ShopSpin: Context detected:",{pageType:e.pageType,productCount:e.products.length,primaryProduct:(t=e.primaryProduct)==null?void 0:t.name,url:window.location.href}),this.hasContextChanged(e)?(console.log("ðŸŽ° ShopSpin: Context changed, updating UI"),this.currentContext=e,this.updateUI(e),e.primaryProduct&&this.notifyBackground(e.primaryProduct)):console.log("ðŸŽ° ShopSpin: No context change detected")}catch(e){console.error("ðŸŽ° ShopSpin detection error:",e)}}hasContextChanged(t){if(!this.currentContext||this.currentContext.pageType!==t.pageType||this.currentContext.products.length!==t.products.length)return!0;const e=this.currentContext.primaryProduct,o=t.primaryProduct;return!e&&!o?!1:!e||!o?!0:e.name!==o.name||e.price!==o.price}updateUI(t){this.removeAllIndicators(),this.removeOverlay(),console.log("ðŸŽ° ShopSpin updateUI:",{pageType:t.pageType,productCount:t.products.length,hasPrimaryProduct:!!t.primaryProduct}),t.pageType==="single-product"&&t.primaryProduct?(console.log("ðŸŽ° ShopSpin: Showing overlay for single product"),this.showOverlay(t.primaryProduct)):t.pageType==="multi-product"&&t.products.length>0?(console.log("ðŸŽ° ShopSpin: Showing subtle promotion for multi-product page"),setTimeout(()=>this.showFloatingPromotion(t.products),2e3)):console.log("ðŸŽ° ShopSpin: No UI shown - page type unknown or no products")}showFloatingPromotion(t){if(document.getElementById("shopspin-floating-promo"))return;const e=t.reduce((s,i)=>s+i.price,0)/t.length,o=Math.min(e*.4,30),n=document.createElement("div");n.id="shopspin-floating-promo",n.style.cssText=`
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 280px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      z-index: 999998;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      cursor: pointer;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.5s ease;
      border: 2px solid rgba(255,255,255,0.2);
    `,n.innerHTML=`
      <div style="display: flex; align-items: center; margin-bottom: 8px;">
        <div style="font-size: 24px; margin-right: 8px;">ðŸŽ°</div>
        <div>
          <div style="font-weight: bold; font-size: 14px;">ShopSpin Extension</div>
          <div style="font-size: 11px; opacity: 0.9;">Win items at fraction of cost!</div>
        </div>
        <button id="shopspin-promo-close" style="margin-left: auto; background: none; border: none; color: white; font-size: 18px; cursor: pointer; opacity: 0.7; width: 24px; height: 24px;">Ã—</button>
      </div>
      <div style="font-size: 12px; margin-bottom: 8px; opacity: 0.95;">
        placeholder
      </div>
      <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 6px; border-radius: 6px; font-size: 11px; font-weight: bold;">
        ðŸ‘† Click any product to start spinning!
      </div>
    `,document.body.appendChild(n),setTimeout(()=>{n.style.transform="translateY(0)",n.style.opacity="1"},100);const r=n.querySelector("#shopspin-promo-close");r==null||r.addEventListener("click",s=>{s.stopPropagation(),this.hideFloatingPromotion()}),n.addEventListener("click",()=>{var s;(s=t[0])!=null&&s.element&&(t[0].element.scrollIntoView({behavior:"smooth",block:"center"}),this.hideFloatingPromotion())}),setTimeout(()=>{this.hideFloatingPromotion()},8e3)}hideFloatingPromotion(){const t=document.getElementById("shopspin-floating-promo");t&&(t.style.transform="translateY(100px)",t.style.opacity="0",setTimeout(()=>t.remove(),500))}removeAllIndicators(){[".shopspin-indicator",".shopspin-value-tooltip",".shopspin-urgent-cta","#shopspin-floating-promo","#shopspin-overlay"].forEach(e=>{document.querySelectorAll(e).forEach(n=>n.remove())}),this.indicatorElements.clear()}notifyBackground(t){chrome.runtime.sendMessage({type:"PRODUCT_FOUND",product:t})}showOverlay(t){console.debug("ShopSpin: Showing overlay for product:",t.name),this.removeOverlay();const e=document.createElement("div");e.id="shopspin-overlay",e.style.cssText=`
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 999999;
      width: 320px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      border: 2px solid #e5e7eb;
    `;const o=e.attachShadow({mode:"open"}),n=document.createElement("div");n.innerHTML=`
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        .container { 
          padding: 16px; 
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border-radius: 12px;
        }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .title { font-size: 16px; font-weight: bold; }
        .close { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }
        .product { margin-bottom: 16px; }
        .product-name { font-size: 14px; margin-bottom: 4px; }
        .product-price { font-size: 18px; font-weight: bold; color: #fef08a; }
        .controls { margin-bottom: 16px; }
        .stake-input { 
          width: 100%; 
          padding: 8px; 
          border: none; 
          border-radius: 6px; 
          font-size: 14px;
          margin-bottom: 8px;
        }
        .probability { text-align: center; margin-bottom: 12px; }
        .prob-text { font-size: 12px; opacity: 0.9; }
        .prob-value { font-size: 20px; font-weight: bold; color: #fef08a; }
        .spin-btn { 
          width: 100%; 
          padding: 12px; 
          background: #fef08a; 
          color: #1f2937; 
          border: none; 
          border-radius: 6px; 
          font-size: 16px; 
          font-weight: bold; 
          cursor: pointer;
          transition: all 0.2s;
        }
        .spin-btn:hover { background: #fde047; transform: translateY(-1px); }
        .spin-btn:disabled { opacity: 0.5; cursor: not-allowed; }
      </style>
      <div class="container">
        <div class="header">
          <div class="title">ðŸŽ° ShopSpin</div>
          <button class="close" id="close-btn">Ã—</button>
        </div>
        <div class="product">
          <div class="product-name">${t.name}</div>
          <div class="product-price">$${t.price.toFixed(2)}</div>
        </div>
        <div class="controls">
          <input type="number" class="stake-input" id="stake-input" 
                 placeholder="Your stake ($)" min="0.01" max="${t.price}" step="0.01">
          <div class="probability">
            <div class="prob-text">Win Probability</div>
            <div class="prob-value" id="probability">0%</div>
          </div>
          <button class="spin-btn" id="spin-btn" disabled>Enter Stake First</button>
        </div>
      </div>
    `,o.appendChild(n);const r=o.getElementById("stake-input"),s=o.getElementById("probability"),i=o.getElementById("spin-btn"),c=o.getElementById("close-btn");r.addEventListener("input",()=>{const l=parseFloat(r.value)||0,a=Math.min(l/t.price*100,100);s.textContent=`${a.toFixed(1)}%`,i.disabled=l<=0||l>t.price,i.textContent=l>0?"ðŸŽ² Spin to Win!":"Enter Stake First"}),i.addEventListener("click",()=>{const l=parseFloat(r.value);this.enterSpin(t,l)}),c.addEventListener("click",()=>{this.removeOverlay()}),document.body.appendChild(e)}removeOverlay(){const t=document.getElementById("shopspin-overlay");t&&t.remove()}enterSpin(t,e){chrome.runtime.sendMessage({type:"ENTER_SPIN",product:t,stake:e},o=>{this.handleSpinResult(o)})}handleSpinResult(t){const e=document.getElementById("shopspin-overlay");if(!(e!=null&&e.shadowRoot))return;const o=e.shadowRoot.querySelector(".container");t.won?o.innerHTML=`
        <div style="text-align: center; padding: 20px;">
          <div style="font-size: 48px; margin-bottom: 16px;">ðŸŽ‰</div>
          <div style="font-size: 20px; font-weight: bold; margin-bottom: 8px;">You Won!</div>
          <div style="font-size: 14px; opacity: 0.9;">${t.message}</div>
        </div>
      `:o.innerHTML=`
        <div style="text-align: center; padding: 20px;">
          <div style="font-size: 48px; margin-bottom: 16px;">ðŸ˜”</div>
          <div style="font-size: 20px; font-weight: bold; margin-bottom: 8px;">Better Luck Next Time!</div>
          <div style="font-size: 14px; opacity: 0.9;">${t.message}</div>
        </div>
      `,setTimeout(()=>this.removeOverlay(),3e3)}debounce(t,e){clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(t,e)}}new v;
