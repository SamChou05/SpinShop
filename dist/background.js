var i={};class c{constructor(){this.setupMessageHandlers(),this.setupInstallHandler()}setupMessageHandlers(){chrome.runtime.onMessage.addListener((e,t,n)=>{switch(e.type){case"PRODUCT_FOUND":this.handleProductFound(e.product);break;case"ENTER_SPIN":return this.handleSpinRequest(e.product,e.stake).then(n),!0}})}setupInstallHandler(){chrome.runtime.onInstalled.addListener(()=>{chrome.storage.sync.set({extensionEnabled:!0,soundEnabled:!1,animationsEnabled:!0})})}handleProductFound(e){console.log("Product detected:",e)}async handleSpinRequest(e,t){if(t<=0||t>e.price)return{won:!1,message:"Invalid stake amount"};const n=Math.min(t/e.price,1),r=new Uint32Array(1);if(crypto.getRandomValues(r),r[0]/4294967296<n){const s=e.price-t;try{const o=await this.createPaymentIntent(s,e);return{won:!0,message:`Congratulations! Pay $${s.toFixed(2)} to complete your purchase.`,paymentIntentId:o.id}}catch(o){return console.error("Payment intent creation failed:",o),{won:!0,message:"You won, but there was an error processing payment. Please try again."}}}else return this.recordSpinResult(e,t,!1),{won:!1,message:`You needed ${(n*100).toFixed(1)}% but luck wasn't on your side. Try again!`}}async createPaymentIntent(e,t){const n=await this.getStripeConfig();if(!n.apiKey)throw new Error("Stripe not configured");const r=await fetch("https://api.stripe.com/v1/payment_intents",{method:"POST",headers:{Authorization:`Bearer ${n.apiKey}`,"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({amount:Math.round(e*100).toString(),currency:"usd","metadata[product_name]":t.name,"metadata[product_url]":t.url,"metadata[original_price]":t.price.toString()})});if(!r.ok)throw new Error(`Stripe API error: ${r.status}`);return await r.json()}async getStripeConfig(){return{apiKey:(await chrome.storage.sync.get(["stripeApiKey"])).stripeApiKey||i.STRIPE_SECRET_KEY}}async recordSpinResult(e,t,n){const a=(await chrome.storage.local.get(["spinHistory"])).spinHistory||[];a.push({timestamp:Date.now(),product:{name:e.name,price:e.price,url:e.url},stake:t,won:n,savings:n?t:0}),a.length>100&&a.splice(0,a.length-100),await chrome.storage.local.set({spinHistory:a})}}new c;
