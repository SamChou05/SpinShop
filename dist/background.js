var i={};class c{constructor(){this.setupMessageHandlers(),this.setupInstallHandler()}setupMessageHandlers(){chrome.runtime.onMessage.addListener((e,n,t)=>{switch(e.type){case"PRODUCT_FOUND":this.handleProductFound(e.product);break;case"ENTER_SPIN":return this.handleSpinRequest(e.product,e.stake).then(t),!0;case"INDICATOR_CLICKED":this.handleIndicatorClick(e.product);break}})}setupInstallHandler(){chrome.runtime.onInstalled.addListener(()=>{chrome.storage.sync.set({extensionEnabled:!0,soundEnabled:!1,animationsEnabled:!0})})}handleProductFound(e){console.log("Product detected:",e)}async handleIndicatorClick(e){const t=(await chrome.storage.local.get(["indicatorClicks"])).indicatorClicks||[];t.push({timestamp:Date.now(),product:{name:e.name,price:e.price,url:e.url},domain:new URL(e.url).hostname}),t.length>500&&t.splice(0,t.length-500),await chrome.storage.local.set({indicatorClicks:t}),console.log("Indicator clicked for product:",e.name)}async handleSpinRequest(e,n){if(n<=0||n>e.price)return{won:!1,message:"Invalid stake amount"};const t=Math.min(n/e.price,1),a=new Uint32Array(1);if(crypto.getRandomValues(a),a[0]/4294967296<t){const s=e.price-n;try{const o=await this.createPaymentIntent(s,e);return{won:!0,message:`Congratulations! Pay $${s.toFixed(2)} to complete your purchase.`,paymentIntentId:o.id}}catch(o){return console.error("Payment intent creation failed:",o),{won:!0,message:"You won, but there was an error processing payment. Please try again."}}}else return this.recordSpinResult(e,n,!1),{won:!1,message:`You needed ${(t*100).toFixed(1)}% but luck wasn't on your side. Try again!`}}async createPaymentIntent(e,n){const t=await this.getStripeConfig();if(!t.apiKey)throw new Error("Stripe not configured");const a=await fetch("https://api.stripe.com/v1/payment_intents",{method:"POST",headers:{Authorization:`Bearer ${t.apiKey}`,"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({amount:Math.round(e*100).toString(),currency:"usd","metadata[product_name]":n.name,"metadata[product_url]":n.url,"metadata[original_price]":n.price.toString()})});if(!a.ok)throw new Error(`Stripe API error: ${a.status}`);return await a.json()}async getStripeConfig(){return{apiKey:(await chrome.storage.sync.get(["stripeApiKey"])).stripeApiKey||i.STRIPE_SECRET_KEY}}async recordSpinResult(e,n,t){const r=(await chrome.storage.local.get(["spinHistory"])).spinHistory||[];r.push({timestamp:Date.now(),product:{name:e.name,price:e.price,url:e.url},stake:n,won:t,savings:t?n:0}),r.length>100&&r.splice(0,r.length-100),await chrome.storage.local.set({spinHistory:r})}}new c;
